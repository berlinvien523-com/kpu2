<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KPU ‚Äî jednoduch√Ω pl√°novaƒç s ISO t√Ωdny</title>
<style>
  :root{
    --bg:#0d1117; --panel:#161b22; --text:#c9d1d9; --muted:#8b949e;
    --border:#30363d; --control-bg:#0b1220; --th-bg:#0b1220;
    --blue:#1f6feb; --accent:#2ea043; --danger:#da3633; --warn:#d29922;
    --font-ui: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
  }
  :root[data-theme="light"]{
    --bg:#ffffff; --panel:#f6f8fa; --text:#24292f; --muted:#57606a;
    --border:#d0d7de; --control-bg:#ffffff; --th-bg:#eef2f7;
    --blue:#0969da; --accent:#1a7f37; --danger:#cf222e; --warn:#9a6700;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.45 var(--font-ui), "Apple Color Emoji","Segoe UI Emoji"; }
  h1,h2,h3{ margin:0 0 6px; font-weight:600; }
  header{ padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(13,17,23,.85); backdrop-filter:saturate(180%) blur(6px); z-index:10; }
  :root[data-theme="light"] header{ background:rgba(255,255,255,.85); }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .right{ margin-left:auto; }
  .pill{ padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:8px; margin:12px 16px; padding:12px; }
  .muted{ color:var(--muted); }
  button,select,input,textarea{ background:var(--control-bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:8px 10px; }
  button{ cursor:pointer; }
  button.primary{ background:var(--blue); border-color:#224f9e; }
  button.ghost{ background:transparent; }
  button.danger{ background:var(--danger); border-color:#8a1f1d; }
  button:disabled{ opacity:.5; cursor:not-allowed; }
  .tabs button{ background:var(--control-bg); }
  .tabs button.active{ background:var(--blue); border-color:#224f9e; }
  #modeSelectWrap{ display:none; }
  @media (max-width:640px){
    .tabs{ display:none; }
    #modeSelectWrap{ display:block; }
  }
  table{ border-collapse:collapse; width:100%; min-width:720px; }
  th,td{ border:1px solid var(--border); padding:6px 8px; text-align:left; }
  th{ background:var(--th-bg); }
  input[type="text"]{ width:100%; }
  .scroll-x{ overflow:auto; }
  .hidden{ display:none !important; }
  /* Admin modal */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:20; }
  .panel{ width:min(920px,95vw); background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:12px; }
  .tabs-admin{ gap:6px; margin:8px 0; }
  .tabs-admin button{ background:var(--control-bg); }
  .tabs-admin button.active{ background:var(--blue); border-color:#224f9e; }
  /* Debug panel */
  #debugWrap{ position:fixed; left:0; right:0; bottom:0; background:var(--panel); border-top:1px solid var(--border); max-height:42vh; display:none; flex-direction:column; }
  #debugHead{ padding:8px 12px; display:flex; align-items:center; gap:8px; border-bottom:1px solid var(--border); }
  #debugBody{ padding:8px 12px; overflow:auto; font-family:ui-monospace, "SF Mono", Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
  .label{ padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid var(--border); }
  .label.warn{ color:#fff; background:#6e5300; }
  .label.ok{ color:#fff; background:#055d20; }
  .label.err{ color:#fff; background:#7a1513; }
  /* Unified task font */
  .task-name, .task-input, #tasksText{ font:14px/1.45 var(--font-ui); }
</style>
</head>
<body>
<header class="row">
  <h1>KPU</h1>
  <span class="pill">LocalStorage</span>
  <div class="tabs right">
    <button class="tab" data-mode="D">Denn√≠</button>
    <button class="tab" data-mode="W">T√Ωdenn√≠</button>
    <button class="tab" data-mode="M">Mƒõs√≠ƒçn√≠</button>
    <button class="tab" data-mode="Q">ƒåtvrtletn√≠</button>
    <button class="tab" data-mode="H">Pololetn√≠</button>
    <button class="tab" data-mode="Y">Roƒçn√≠</button>
  </div>
  <div id="modeSelectWrap" class="right">
    <select id="modeSelect" title="Re≈æim">
      <option value="D">Denn√≠</option>
      <option value="W">T√Ωdenn√≠</option>
      <option value="M">Mƒõs√≠ƒçn√≠</option>
      <option value="Q">ƒåtvrtletn√≠</option>
      <option value="H">Pololetn√≠</option>
      <option value="Y">Roƒçn√≠</option>
    </select>
  </div>
  <button id="btnTheme" class="ghost right" title="P≈ôepnout t√©ma" aria-label="P≈ôepnout t√©ma">üåô</button>
  <button id="btnAdmin" class="right">üîí Admin</button>
</header>

<main>
  <div class="card">
    <div class="row"><span id="modeHint" class="muted"></span></div>
    <div id="selectorRow" class="row" style="margin-top:6px"></div>
    <div class="row"><span id="status" class="muted"></span></div>
  </div>
  <div class="card scroll-x">
    <table id="tbl"></table>
  </div>
</main>

<!-- Admin modal -->
<div id="adminModal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <div class="row">
      <strong>Admin</strong>
      <button id="adminClose" class="right ghost">Zav≈ô√≠t</button>
    </div>

    <div id="adminGate">
      <p class="muted">Zadej PIN pro p≈ô√≠stup do administrace.</p>
      <div class="row" id="pinRow">
        <input id="pinInput" type="password" placeholder="PIN (4‚Äì12 znak≈Ø)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="numeric">
        <button id="pinEnter" class="primary" type="button">Vstoupit</button>
      </div>
      <div id="setupPin" class="hidden">
        <p class="muted">Prvn√≠ spu≈°tƒõn√≠: nastav PIN pro administraci.</p>
        <div class="row">
          <input id="pinSetup1" type="password" placeholder="Nov√Ω PIN (4‚Äì12 znak≈Ø)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="numeric">
          <input id="pinSetup2" type="password" placeholder="Znovu nov√Ω PIN" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="numeric">
          <button id="pinSetupBtn" class="primary" type="button">Nastavit PIN</button>
        </div>
        <div class="row"><span id="pinSetupMsg" class="muted"></span></div>
        <p class="muted">PIN se ukl√°d√° pouze lok√°lnƒõ v tomto prohl√≠≈æeƒçi.</p>
      </div>
      <p class="muted" id="pinInfo"></p>
    </div>

    <div id="adminBody" class="hidden">
      <div class="row tabs-admin" style="margin:10px 0">
        <button data-tab="data" class="active">Data</button>
        <button data-tab="tasks">√ökoly</button>
        <button data-tab="sec">Zabezpeƒçen√≠</button>
      </div>

      <section id="tab-data">
        <div class="row" style="margin:8px 0">
          <button id="btnExport">Export (JSON)</button>
          <input id="fileImport" type="file" accept="application/json">
          <button id="btnImport">Import</button>
          <button id="btnReset" class="danger" type="button" onclick="try{onResetClick(event)}catch(e){console.error(e)}">Vymazat v≈°echna data</button>
          <button id="btnResetAll" class="danger" type="button" onclick="try{onResetAllClick(event)}catch(e){console.error(e)}">Vymazat v≈°echna data + PIN</button>
        </div>
        <div class="row" style="margin:8px 0">
          <button id="btnPickFile">Vybrat c√≠lov√Ω soubor (FSA)</button>
          <label class="muted">Auto z√°loha:</label>
          <input id="backupAuto" type="checkbox">
          <span id="backupInfo" class="muted"></span>
        </div>
        <div class="row" style="margin:8px 0">
          <label class="muted">Debug panel:</label>
          <input id="debugEnable" type="checkbox">
        </div>
        <div class="row" style="margin:8px 0">
          <label class="muted">V≈ædy otev≈ô√≠t dne≈°ek:</label>
          <input id="alwaysToday" type="checkbox">
        </div>
      </section>

      <section id="tab-tasks" class="hidden">
        <div class="row" style="margin-bottom:6px">
          <span class="muted">Seznam √∫kol≈Ø pro aktu√°ln√≠ re≈æim (<span id="modeBadge"></span>) ‚Äî jeden ≈ô√°dek = jeden √∫kol.</span>
        </div>
        <textarea id="tasksText" rows="10" style="width:100%; resize:vertical" placeholder="Napi≈° √∫koly, ka≈æd√Ω na nov√Ω ≈ô√°dek"></textarea>
        <div class="row" style="margin-top:6px">
          <button id="tasksSave" class="primary">Ulo≈æit √∫koly</button>
          <button id="tasksClear" class="ghost">Vyƒçistit √∫koly</button>
          <span id="tasksMsg" class="muted"></span>
        </div>
      </section>

      <section id="tab-sec" class="hidden">
        <p class="muted">Zmƒõna PINu pro admin menu.</p>
        <div class="row">
          <input id="pinNew1" type="password" placeholder="Nov√Ω PIN (4‚Äì12 znak≈Ø)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="numeric">
          <input id="pinNew2" type="password" placeholder="Znovu nov√Ω PIN" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="numeric">
          <button id="pinChange" class="primary" type="button">Zmƒõnit PIN</button>
        </div>
        <div class="row"><span id="pinChangeMsg" class="muted"></span></div>
      </section>
    </div>
  </div>
</div>

<!-- Debug panel -->
<div id="debugWrap">
  <div id="debugHead">
    <strong>Debug log</strong>
    <span id="debugStatus" class="label ok">ON</span>
    <button id="debugClear" class="right ghost">Vyƒçistit</button>
    <button id="debugHide" class="ghost">Skr√Ωt</button>
  </div>
  <div id="debugBody"></div>
</div>

<script>
/*** ========== Store & UI helpers ========== ***/

// --- Robust wipe helpers (store-only / all)
function __wipe(kind){
  try{ __dbg.log("Wipe start", kind); }catch(_){}
  // Attempt removals
  try{ if (kind==="all"){ localStorage.removeItem(PIN_KEY); __dbg.log("Removed PIN_KEY"); } }catch(e){ try{__dbg.error("remove PIN_KEY", e);}catch(_){}} 
  try{ localStorage.removeItem(LS_KEY); __dbg.log("Removed LS_KEY"); }catch(e){ try{__dbg.error("remove LS_KEY", e);}catch(_){}} 
  // Verify and fallback
  try{
    const stillStore = localStorage.getItem(LS_KEY) !== null;
    const stillPin = localStorage.getItem(PIN_KEY) !== null;
    if (stillStore || (kind==="all" && stillPin)){
      try{ localStorage.clear(); __dbg.log("Fallback localStorage.clear() used"); }catch(e){ try{__dbg.error("clear fallback failed", e);}catch(_){}} 
    }
  }catch(_){}
  // UI feedback and hard reload
  try{ document.getElementById("status").textContent = "Vymaz√°no. Obnovuji‚Ä¶"; }catch(_){}
  setTimeout(()=>{ try{ location.replace(location.href.split("#")[0]); }catch(_){ location.reload(); } }, 80);
}

// Inline fallback handlers (in case addEventListener is blocked by the browser)
function onResetClick(e){
  if (e) e.preventDefault();
  try{ __dbg.log("onResetClick"); }catch(_){}
  if (!confirm("Opravdu smazat v≈°echna ulo≈æen√° data? PIN z≈Østane zachov√°n.")) return;
  __wipe("store");
}
function onResetAllClick(e){
  if (e) e.preventDefault();
  try{ __dbg.log("onResetAllClick"); }catch(_){}
  if (!confirm("Smazat opravdu v≈°e vƒçetnƒõ PINu?")) return;
  __wipe("all");
}

const LS_KEY = "kpu_v2_store";
const PIN_KEY = "kpu_v2_pin";
const THEME_KEY = "kpu_v2_theme";

function getStore(){
  try{ const raw = localStorage.getItem(LS_KEY); return raw? JSON.parse(raw): {}; }catch(e){ console.error("getStore parse error", e); return {}; }
}
function setStore(s){ try{ localStorage.setItem(LS_KEY, JSON.stringify(s)); }catch(e){ console.error("setStore error", e); } }
function getUI(){ const s=getStore(); return s.ui||{}; }
function setUI(ui){ const s=getStore(); s.ui=ui; setStore(s); }

/*** ========== Debug panel ========== ***/
const __dbg=(function(){
  const wrap=document.getElementById("debugWrap");
  const body=document.getElementById("debugBody");
  const status=document.getElementById("debugStatus");
  const origLog = console.log.bind(console);
  const origErr = console.error.bind(console);
  function append(kind, args){
    const t=new Date().toLocaleTimeString();
    const line=document.createElement("div");
    const txt=args.map(a=>{ try{ return (typeof a==="object")? JSON.stringify(a): String(a); }catch(_){ return String(a);} }).join(" ");
    line.innerHTML="<span class='muted'>["+t+"]</span> "+(kind==="error"?"<span class='label err'>ERR</span> ":"")+txt;
    body.appendChild(line); body.scrollTop=body.scrollHeight;
  }
  console.log=(...a)=>{ append("log", a); origLog(...a); };
  console.error=(...a)=>{ append("error", a); origErr(...a); };
  return { set:(on)=>{ wrap.style.display=on?"flex":"none"; status.textContent=on?"ON":"OFF"; status.className="label "+(on?"ok":"warn"); }, log:(...a)=>console.log(...a), error:(...a)=>console.error(...a), clear:()=>{ body.innerHTML=""; } };
})();

/*** ========== Theme ========== ***/
function applyTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  const btn=document.getElementById("btnTheme");
  if(btn){ btn.textContent=(t==="light")?"‚òÄÔ∏è":"üåô"; btn.title=(t==="light")?"P≈ôepnout na tmav√©":"P≈ôepnout na svƒõtl√©"; btn.setAttribute("aria-label", btn.title); }
}
function detectInitialTheme(){
  const stored=localStorage.getItem(THEME_KEY);
  if (stored==="light"||stored==="dark") return stored;
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  return prefersDark? "dark":"light";
}
let THEME = detectInitialTheme();
applyTheme(THEME);
document.getElementById("btnTheme").addEventListener("click", ()=>{ THEME=(THEME==="light")?"dark":"light"; localStorage.setItem(THEME_KEY, THEME); applyTheme(THEME); });
try{ const mq=window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)"); if(mq && !localStorage.getItem(THEME_KEY)){ mq.addEventListener("change", e=>{ THEME=e.matches?"dark":"light"; applyTheme(THEME); }); } }catch(_){}

/*** ========== Security (PIN) ========== ***/
function __cleanPinValue(x){ let s=String(x==null? "": x).normalize("NFKC").trim(); s=s.replace(/[\u200B\u200C\u200D\uFEFF]/g,""); return s; }
function isValidPin(s){ const c=__cleanPinValue(s); if(c.length<4||c.length>12) return false; if(/\s/.test(c)) return false; return true; }
async function hasPin(){ return !!localStorage.getItem(PIN_KEY); }
async function verifyPin(pin){ try{ const raw=localStorage.getItem(PIN_KEY); if(!raw) return false; const {hash}=JSON.parse(raw); const hIn=await sha256(__cleanPinValue(pin)); return hIn===hash; }catch(e){ __dbg.error("verifyPin error", e); return false; } }
async function changePin(p1,p2){
  const c1=__cleanPinValue(p1), c2=__cleanPinValue(p2);
  if (c1!==c2) throw new Error("PIN se neshoduje.");
  if (!isValidPin(c1)) throw new Error("PIN mus√≠ m√≠t 4‚Äì12 znak≈Ø bez mezer (po o≈ôezu "+c1.length+" znak≈Ø).");
  const hash=await sha256(c1);
  localStorage.setItem(PIN_KEY, JSON.stringify({hash}));
  __dbg.log("PIN changed");
}

/*** ========== SHA-256 (with JS fallback) ========== ***/
async function sha256(text){
  if (window.crypto && window.crypto.subtle){
    const data=new TextEncoder().encode(text);
    const buf=await window.crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function rrot(n,x){ return (x>>>n) | (x<<(32-n)); } function ch(x,y,z){ return (x & y) ^ (~x & z); } function maj(x,y,z){ return (x & y) ^ (x & z) ^ (y & z); }
  function SIG0(x){ return rrot(2,x)^rrot(13,x)^rrot(22,x); } function SIG1(x){ return rrot(6,x)^rrot(11,x)^rrot(25,x); }
  function sig0(x){ return rrot(7,x)^rrot(18,x)^(x>>>3); } function sig1(x){ return rrot(17,x)^rrot(19,x)^(x>>>10); }
  const K=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];
  let msg=new TextEncoder().encode(String(text)); let l=msg.length*8; let withOne=new Uint8Array(((msg.length+9+63)>>6)<<6);
  withOne.set(msg); withOne[msg.length]=0x80;
  let dv=new DataView(withOne.buffer); dv.setUint32(withOne.length-4, l>>>0); dv.setUint32(withOne.length-8, Math.floor(l/2**32));
  let H0=0x6a09e667,H1=0xbb67ae85,H2=0x3c6ef372,H3=0xa54ff53a,H4=0x510e527f,H5=0x9b05688c,H6=0x1f83d9ab,H7=0x5be0cd19; let W=new Uint32Array(64);
  for(let i=0;i<withOne.length;i+=64){ for(let t=0;t<16;t++) W[t]=dv.getUint32(i+t*4); for(let t=16;t<64;t++) W[t]=(sig1(W[t-2])+W[t-7]+sig0(W[t-15])+W[t-16])>>>0;
    let a=H0,b=H1,c=H2,d=H3,e=H4,f=H5,g=H6,h=H7; for(let t=0;t<64;t++){ let T1=(h+SIG1(e)+ch(e,f,g)+K[t]+W[t])>>>0; let T2=(SIG0(a)+maj(a,b,c))>>>0; h=g; g=f; f=e; e=(d+T1)>>>0; d=c; c=b; b=a; a=(T1+T2)>>>0; }
    H0=(H0+a)>>>0; H1=(H1+b)>>>0; H2=(H2+c)>>>0; H3=(H3+d)>>>0; H4=(H4+e)>>>0; H5=(H5+f)>>>0; H6=(H6+g)>>>0; H7=(H7+h)>>>0;
  }
  const H=[H0,H1,H2,H3,H4,H5,H6,H7]; return H.map(x=>x.toString(16).padStart(8,"0")).join("");
}

/*** ========== Calendar helpers ========== ***/
function fmtDMY(d){ const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); return dd+"."+mm+"."+d.getFullYear(); }
function weekLabel(obj){ return obj.week + ". t√Ωden (" + fmtDMY(obj.start) + "‚Äì" + fmtDMY(obj.end) + ")"; }

function isoWeeksForYear(year){
  // ISO t√Ωden 1 = t√Ωden s 4. lednem; t√Ωdny zaƒç√≠naj√≠ pondƒõl√≠m
  // Vyrob√≠me pondƒõl√≠ t√Ωdne 1 pro dan√Ω rok i pro rok n√°sleduj√≠c√≠ a iterujeme mezi nimi.
  const jan4   = new Date(year, 0, 4);
  const d1     = (jan4.getDay() || 7); // Po=1..Ne=7
  const w1Mon  = new Date(jan4); w1Mon.setDate(jan4.getDate() - (d1 - 1)); // m≈Ø≈æe b√Ωt v prosinci p≈ôedchoz√≠ho roku

  const jan4Nx = new Date(year + 1, 0, 4);
  const d2     = (jan4Nx.getDay() || 7);
  const w1MonNx= new Date(jan4Nx); w1MonNx.setDate(jan4Nx.getDate() - (d2 - 1));

  const weeks = [];
  for (let curMon = new Date(w1Mon); curMon < w1MonNx; ){
    const curSun = new Date(curMon); curSun.setDate(curMon.getDate() + 6);
    weeks.push({ week: weeks.length + 1, start: new Date(curMon), end: curSun });
    curMon.setDate(curMon.getDate() + 7);
    if (weeks.length > 54) break;
  }
  return weeks;
}


function isoWeekInfo(dt){
  // Vrac√≠ {year: ISO t√Ωdenn√≠ rok, week: ISO ƒç√≠slo t√Ωdne}
  const d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  const dayNr = (d.getDay() + 6) % 7; // Po=0..Ne=6
  const th = new Date(d);
  th.setDate(d.getDate() - dayNr + 3); // posun na ƒçtvrtek
  const isoYear = th.getFullYear();
  const firstTh = new Date(isoYear, 0, 4);
  const firstThDay = (firstTh.getDay() + 6) % 7;
  firstTh.setDate(firstTh.getDate() - firstThDay + 3);
  const week = 1 + Math.round((th - firstTh) / (7 * 24 * 60 * 60 * 1000));
  return {year: isoYear, week: week};
}

/*** ========== UI / re≈æimy / selektory ========== ***/
let MODE="W";
const MONTHS=["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"];
const selectorRow=document.getElementById("selectorRow");
const tbl=document.getElementById("tbl");
const statusEl=document.getElementById("status");
const modeHint=document.getElementById("modeHint");
const modeSelect=document.getElementById("modeSelect");

function setMode(m){
  MODE=m;
  document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.getAttribute("data-mode")===MODE));
  try{ if(modeSelect) modeSelect.value = MODE; }catch(_){}
  const ui=getUI(); ui.mode=MODE; setUI(ui);
  renderSelector(); renderTable(loadCurrent());
  modeHint.textContent = (MODE==="D") ? "Denn√≠: vyber rok + mƒõs√≠c. Ukl√°d√° se automaticky." : "Ukl√°d√° se automaticky.";
}

function renderSelector(){
  try{
    selectorRow.innerHTML="";
    // Rok
    const labY=document.createElement("label"); labY.innerHTML="<strong>Rok</strong>";
    const selY=document.createElement("select"); selY.id="yearSelect";
    const y0=(new Date()).getFullYear(); for(let y=y0-1;y<=y0+2;y++){ const o=document.createElement("option"); o.value=String(y); o.textContent=String(y); selY.appendChild(o); }
    selectorRow.appendChild(labY); selectorRow.appendChild(selY);
    const ui=getUI(); if (ui.year && ui.year[MODE]) selY.value = String(ui.year[MODE]);
    const __prefs=(getStore().prefs||{}); const __always=!!__prefs.alwaysToday; const __today=new Date();
    if (__always){ let defYear=String(__today.getFullYear()); if (MODE==="W"){ const info=isoWeekInfo(__today); defYear=String(info.year);} selY.value=defYear; try{ __dbg.log("AlwaysToday: year", defYear); }catch(_){} }
    // Obdob√≠
    const labP=document.createElement("label"); labP.style.marginLeft="10px"; labP.innerHTML="<strong>Obdob√≠</strong>";
    const selP=document.createElement("select"); selP.id="periodSelect";
    if (MODE==="W"){
      const y=parseInt(selY.value,10);
      isoWeeksForYear(y).forEach(w=>{ const o=document.createElement("option"); o.value=String(w.week); o.textContent=weekLabel(w); selP.appendChild(o); });
      selectorRow.appendChild(labP); selectorRow.appendChild(selP);
    }
    if (MODE==="M" || MODE==="D"){
      MONTHS.forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; selP.appendChild(o); });
      selectorRow.appendChild(labP); selectorRow.appendChild(selP);
    }
    if (MODE==="Q"){
      ["Q1","Q2","Q3","Q4"].forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; selP.appendChild(o); });
      selectorRow.appendChild(labP); selectorRow.appendChild(selP);
    }
    if (MODE==="H"){
      ["H1","H2"].forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; selP.appendChild(o); });
      selectorRow.appendChild(labP); selectorRow.appendChild(selP);
    }
    if (MODE==="Y"){ /* jen rok */ }

    if (selP.options.length && ui.period && ui.period[MODE]){
      for (let i=0;i<selP.options.length;i++) if (selP.options[i].value===ui.period[MODE]) selP.selectedIndex=i;
    }
    if (selP.options.length && __always){
      let defPeriod=null;
      if (MODE==="W"){ const info=isoWeekInfo(__today); defPeriod=String(info.week); }
      if (MODE==="M" || MODE==="D"){ defPeriod = MONTHS[__today.getMonth()]; }
      if (MODE==="Q"){ defPeriod = "Q"+(Math.floor(__today.getMonth()/3)+1); }
      if (MODE==="H"){ defPeriod = (__today.getMonth()<6) ? "H1" : "H2"; }
      if (defPeriod!==null){ for(let i=0;i<selP.options.length;i++){ if (selP.options[i].value===defPeriod){ selP.selectedIndex=i; break; } }
        try{ __dbg.log("AlwaysToday: period", defPeriod); }catch(_){} }
    }

    selY.addEventListener("change", ()=>{ const ui=getUI(); ui.year=ui.year||{}; ui.year[MODE]=selY.value; setUI(ui); renderSelector(); renderTable(loadCurrent()); });
    selP.addEventListener("change", ()=>{ const ui=getUI(); ui.period=ui.period||{}; ui.period[MODE]=selP.value; setUI(ui); renderTable(loadCurrent()); });
  }catch(e){ __dbg.error("renderSelector error", e); }
}

function monthLength(monthName, year){ const idx=MONTHS.indexOf(monthName); return idx<0? 30 : new Date(year, idx+1, 0).getDate(); }

/*** ========== Tasks & Values ========== ***/
function getTasks(){ const s=getStore(); return (s.tasks && Array.isArray(s.tasks[MODE])) ? s.tasks[MODE] : []; }
function setTasks(arr){ const s=getStore(); s.tasks=s.tasks||{}; s.tasks[MODE]=arr; setStore(s); }
function loadCurrent(){
  const s=getStore(); s.values=s.values||{}; s.values[MODE]=s.values[MODE]||{};
  const year=document.getElementById("yearSelect").value;
  if (!s.values[MODE][year]) s.values[MODE][year]={};
  if (MODE==="D"){
    const month=document.getElementById("periodSelect").value; s.values.D=s.values.D||{}; s.values.D[year]=s.values.D[year]||{}; s.values.D[year][month]=s.values.D[year][month]||{};
    return s.values.D[year][month];
  } else if (MODE==="Y"){
    s.values.Y=s.values.Y||{}; s.values.Y[year]=s.values.Y[year]||{}; return s.values.Y[year];
  } else {
    const period=document.getElementById("periodSelect")? document.getElementById("periodSelect").value : null;
    if (period && !s.values[MODE][year][period]) s.values[MODE][year][period]={};
    return (period? s.values[MODE][year][period] : {}) || {};
  }
}
function saveCurrent(obj){
  const s=getStore(); s.values=s.values||{};
  const year=document.getElementById("yearSelect").value;
  if (MODE==="D"){
    const month=document.getElementById("periodSelect").value;
    s.values.D=s.values.D||{}; s.values.D[year]=s.values.D[year]||{}; s.values.D[year][month]=obj;
  } else if (MODE==="Y"){
    s.values.Y=s.values.Y||{}; s.values.Y[year]=obj;
  } else {
    const period=document.getElementById("periodSelect").value;
    s.values[MODE]=s.values[MODE]||{}; s.values[MODE][year]=s.values[MODE][year]||{}; s.values[MODE][year][period]=obj;
  }
  setStore(s);
}

/*** ========== Table ========== ***/
function renderTable(current){
  try{
    const tasks=getTasks();
    if (!Array.isArray(tasks) || tasks.length===0){
      let thead="<thead><tr><th>√ökoly</th></tr></thead>";
      let body="<tbody><tr><td>≈Ω√°dn√© √∫koly nejsou definovan√©. <button id='openTasksEditor' type='button'>Otev≈ô√≠t editor √∫kol≈Ø</button></td></tr></tbody>";
      tbl.innerHTML=thead+body;
      document.getElementById("openTasksEditor").addEventListener("click", ()=>{ document.getElementById("btnAdmin").click(); setTimeout(()=> openAdminTab("tasks"), 0); });
      statusEl.textContent="P≈ôidej √∫koly v Admin ‚Üí √ökoly."; __dbg.log("renderTable: no tasks");
      return;
    }
    const year=document.getElementById("yearSelect").value;
    if (MODE==="D"){
      const month=document.getElementById("periodSelect").value; const days=monthLength(month,year);
      let thead="<thead><tr><th>#</th><th>√ökol</th>"; for(let d=1; d<=days; d++) thead+="<th>"+d+"</th>"; thead+="</tr></thead>";
      let body="<tbody>";
      tasks.forEach((t,i)=>{
        body+="<tr><td>"+(i+1)+"</td><td class='task-name'>"+t.replace(/</g,"&lt;")+"</td>";
        for(let d=1; d<=days; d++){
          const v=(current[t] && current[t][d])? current[t][d] : "";
          body+="<td><input class='task-input' data-task='"+t.replace(/'/g,"&#39;")+"' data-day='"+d+"' type='text' value='"+String(v).replace(/'/g,"&#39;")+"' style='width:90px'></td>";
        } body+="</tr>";
      });
      body+="</tbody>"; tbl.innerHTML=thead+body;
    } else {
      let thead="<thead><tr><th>#</th><th>√ökol</th><th>Hodnota</th></tr></thead>"; let body="<tbody>";
      tasks.forEach((t,i)=>{
        const v=current[t]? current[t] : "";
        body+="<tr><td>"+(i+1)+"</td><td class='task-name'>"+t.replace(/</g,"&lt;")+"</td><td><input class='task-input' data-task='"+t.replace(/'/g,"&#39;")+"' type='text' value='"+String(v).replace(/'/g,"&#39;")+"' style='width:100%'></td></tr>";
      });
      body+="</tbody>"; tbl.innerHTML=thead+body;
    }
    tbl.removeEventListener("input", onTableInput); tbl.addEventListener("input", onTableInput);
    tbl.removeEventListener("keydown", onGridKey); tbl.addEventListener("keydown", onGridKey);
    statusEl.textContent="Naƒçteno.";
  }catch(e){ __dbg.error("renderTable error", e); }
}
function onTableInput(e){ const t=e.target; if (t && t.tagName==="INPUT"){ autoSave(); } }

function onGridKey(e){
  const t = e.target;
  if (!t || t.tagName !== "INPUT") return;
  if (e.altKey || e.metaKey || e.ctrlKey) return;
  const key = e.key;
  const tr = t.closest("tr");
  if (!tr) return;
  const tbody = tr.parentNode;
  const rows = Array.from(tbody.querySelectorAll("tr"));

  function focusEl(el){
    if (el){ el.focus(); try{ el.select(); }catch(_){} }
  }

  if (MODE === "D" && t.hasAttribute("data-day")){
    const rIndex = rows.indexOf(tr);
    const rowInputs = Array.from(tr.querySelectorAll("input[data-day]"));
    const cIndex = rowInputs.indexOf(t);
    const day = t.getAttribute("data-day");

    if (key === "ArrowUp"){
      if (rIndex > 0){
        const upRow = rows[rIndex - 1];
        const target = upRow.querySelector("input[data-day='"+day+"']");
        if (target){ e.preventDefault(); focusEl(target); }
      }
      return;
    }
    if (key === "ArrowDown"){
      if (rIndex < rows.length - 1){
        const dnRow = rows[rIndex + 1];
        const target = dnRow.querySelector("input[data-day='"+day+"']");
        if (target){ e.preventDefault(); focusEl(target); }
      }
      return;
    }
    if (key === "ArrowLeft"){
      const atStart = (t.selectionStart === 0 && t.selectionEnd === 0);
      if (atStart && cIndex > 0){ e.preventDefault(); focusEl(rowInputs[cIndex - 1]); }
      return;
    }
    if (key === "ArrowRight"){
      const atEnd = (t.selectionStart === t.value.length && t.selectionEnd === t.value.length);
      if (atEnd && cIndex < rowInputs.length - 1){ e.preventDefault(); focusEl(rowInputs[cIndex + 1]); }
      return;
    }
    return;
  }

  // Other modes: one input per row, allow only Up/Down
  const allInputs = Array.from(tbody.querySelectorAll("input[data-task]"));
  if (allInputs.length === 0) return;
  const idx = allInputs.indexOf(t);
  if (idx < 0) return;

  if (key === "ArrowUp"){
    if (idx > 0){ e.preventDefault(); focusEl(allInputs[idx - 1]); }
    return;
  }
  if (key === "ArrowDown"){
    if (idx < allInputs.length - 1){ e.preventDefault(); focusEl(allInputs[idx + 1]); }
    return;
  }
}

let saveTimer=null;
function autoSave(){
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{
    const current=loadCurrent();
    if (MODE==="D"){
      const rows=tbl.querySelectorAll("tbody tr"); const obj={};
      rows.forEach(tr=>{
        const task=tr.children[1]?.textContent || ""; obj[task]=obj[task]||{};
        for(let i=2;i<tr.children.length;i++){ const inp=tr.children[i].querySelector("input"); const day=parseInt(inp.getAttribute("data-day"),10); obj[task][day]=inp.value; }
      });
      saveCurrent(obj);
    } else {
      const inputs=tbl.querySelectorAll("input[data-task]"); const obj={}; inputs.forEach(inp=>{ obj[inp.getAttribute("data-task")]=inp.value; }); saveCurrent(obj);
    }
    statusEl.textContent="Ulo≈æeno."; doBackupMaybe();
  }, 350);
}

/*** ========== Admin UI ========== ***/
const adminModal=document.getElementById("adminModal");
const adminGate=document.getElementById("adminGate");
const adminBody=document.getElementById("adminBody");
const adminClose=document.getElementById("adminClose");
const btnAdmin=document.getElementById("btnAdmin");

btnAdmin.addEventListener("click", async (e)=>{
  e.preventDefault();
  adminModal.style.display="flex";
  document.getElementById("pinInput").value="";
  const infoEl=document.getElementById("pinInfo"); infoEl.textContent="";
  const setup=document.getElementById("setupPin"); const pinRow=document.getElementById("pinRow");
  const has=await hasPin();
  adminGate.classList.remove("hidden"); adminBody.classList.add("hidden");
  if (!has){ setup.classList.remove("hidden"); pinRow.classList.add("hidden"); infoEl.textContent="Prvn√≠ spu≈°tƒõn√≠: nastav PIN a pot√© vstoup√≠≈° do administrace."; document.getElementById("pinSetup1").focus(); }
  else { setup.classList.add("hidden"); pinRow.classList.remove("hidden"); document.getElementById("pinInput").focus(); }
  __dbg.log("Admin open");
});
adminClose.addEventListener("click", (e)=>{ e.preventDefault(); adminModal.style.display="none"; __dbg.log("Admin close"); });

document.getElementById("pinEnter").addEventListener("click", async ()=>{
  const ok=await verifyPin(String(document.getElementById("pinInput").value||""));
  if (!ok){ document.getElementById("pinInfo").textContent="≈†patn√Ω PIN."; __dbg.error("PIN wrong"); return; }
  adminGate.classList.add("hidden"); adminBody.classList.remove("hidden"); openAdminTab("data"); __dbg.log("Admin gate success");
});
document.getElementById("pinSetupBtn").addEventListener("click", async ()=>{
  try{
    const p1=String(document.getElementById("pinSetup1").value||"");
    const p2=String(document.getElementById("pinSetup2").value||"");
    __dbg.log("Setup attempt lengths", __cleanPinValue(p1).length, __cleanPinValue(p2).length);
    await changePin(p1,p2);
    document.getElementById("pinInfo").textContent="PIN nastaven. Vstupuji do administrace‚Ä¶";
    adminGate.classList.add("hidden"); adminBody.classList.remove("hidden"); openAdminTab("data"); __dbg.log("First-time PIN set");
  }catch(err){ alert(err && err.message ? err.message : "Chyba p≈ôi nastavov√°n√≠ PINu."); }
});

// Admin tabs
const adminTabs=document.querySelectorAll(".tabs-admin button");
adminTabs.forEach(b=> b.addEventListener("click", (e)=>{ e.preventDefault(); openAdminTab(b.getAttribute("data-tab")); }));
function openAdminTab(id){
  adminTabs.forEach(b=> b.classList.toggle("active", b.getAttribute("data-tab")===id));
  document.getElementById("tab-data").classList.toggle("hidden", id!=="data");
  document.getElementById("tab-tasks").classList.toggle("hidden", id!=="tasks");
  document.getElementById("tab-sec").classList.toggle("hidden", id!=="sec");
  if (id==="tasks"){ document.getElementById("modeBadge").textContent=MODE; document.getElementById("tasksText").value=getTasks().join("\\n"); }
}

// PIN change
document.getElementById("pinChange").addEventListener("click", async ()=>{
  try{
    const p1=String(document.getElementById("pinNew1").value||"");
    const p2=String(document.getElementById("pinNew2").value||"");
    __dbg.log("Change attempt lengths", __cleanPinValue(p1).length, __cleanPinValue(p2).length);
    await changePin(p1,p2);
    alert("PIN zmƒõnƒõn."); document.getElementById("pinNew1").value=""; document.getElementById("pinNew2").value="";
  }catch(err){ alert(err && err.message ? err.message : "Chyba p≈ôi zmƒõnƒõ PINu."); }
});

// Data (export/import/reset)
document.getElementById("btnExport").addEventListener("click", ()=>{
  const s=getStore(); const blob=new Blob([JSON.stringify(s,null,2)], {type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="KPU_backup.json"; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById("btnImport").addEventListener("click", async ()=>{
  const f=document.getElementById("fileImport").files[0];
  if(!f){ alert("Vyber soubor k importu."); return; }
  try{ const text=await f.text(); const obj=JSON.parse(text); setStore(obj); renderSelector(); renderTable(loadCurrent()); alert("Import hotov."); }
  catch(e){ alert("Chybn√Ω JSON."); }
});
document.getElementById("btnReset").addEventListener("click", (e)=>{
  e.preventDefault();
  if (!confirm("Opravdu smazat v≈°echna ulo≈æen√° data? PIN z≈Østane zachov√°n.")) return;
  e.currentTarget.disabled = true;
  __wipe("store");
});
document.getElementById("btnResetAll").addEventListener("click", (e)=>{
  e.preventDefault();
  if (!confirm("Smazat opravdu v≈°e vƒçetnƒõ PINu?")) return;
  e.currentTarget.disabled = true;
  __wipe("all");
});

// Backup (FSA + auto)
let fileHandle=null;
document.getElementById("btnPickFile").addEventListener("click", async ()=>{
  try{
    if (!window.showSaveFilePicker) { alert("Pro p≈ô√≠m√© ukl√°d√°n√≠ do souboru je pot≈ôeba Chromium prohl√≠≈æeƒç na desktopu (HTTPS/localhost)."); return; }
    fileHandle = await window.showSaveFilePicker({ suggestedName:"KPU_backup.json", types:[{description:"JSON", accept:{"application/json":[".json"]}}] });
    document.getElementById("backupInfo").textContent = "Soubor vybr√°n pro tuto relaci.";
  }catch(e){ __dbg.error("pickFile", e); }
});
document.getElementById("backupAuto").addEventListener("change", (e)=>{
  const s=getStore(); s.backup=s.backup||{}; s.backup.auto=!!e.target.checked; setStore(s);
  document.getElementById("backupInfo").textContent = s.backup.auto ? "Auto z√°loha po ulo≈æen√≠." : "";
});
async function doBackupMaybe(){
  const s=getStore(); if(!(s.backup && s.backup.auto)) return;
  const data=JSON.stringify(getStore(), null, 2);
  try{
    if (fileHandle){ const w=await fileHandle.createWritable(); await w.write(data); await w.close(); __dbg.log("FSA backup OK"); }
    else { const blob=new Blob([data], {type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="KPU_backup.json"; a.click(); URL.revokeObjectURL(a.href); __dbg.log("Download backup OK"); }
  }catch(e){ __dbg.error("backup error", e); }
}

// AlwaysToday toggle
try{ const at=document.getElementById("alwaysToday"); if(at){ at.checked=!!(getStore().prefs && getStore().prefs.alwaysToday); at.addEventListener("change",(e)=>{ const s=getStore(); s.prefs=s.prefs||{}; s.prefs.alwaysToday=!!e.target.checked; setStore(s); try{ __dbg.log("AlwaysToday set to", s.prefs.alwaysToday); }catch(_){} renderSelector(); renderTable(loadCurrent()); }); } }catch(_){ }

// Debug toggle
document.getElementById("debugEnable").addEventListener("change", (e)=>{
  const s=getStore(); s.debug=s.debug||{}; s.debug.enabled=!!e.target.checked; setStore(s); __dbg.set(s.debug.enabled);
});

// Tasks editor
document.getElementById("tasksSave").addEventListener("click", ()=>{
  const lines = document.getElementById("tasksText").value.split(/\\r?\\n/).map(x=>x.trim()).filter(Boolean);
  setTasks(lines); renderTable(loadCurrent());
  document.getElementById("tasksMsg").textContent="Ulo≈æeno.";
});
document.getElementById("tasksClear").addEventListener("click", ()=>{
  setTasks([]); renderTable(loadCurrent()); document.getElementById("tasksMsg").textContent="Vyƒçi≈°tƒõno.";
});

/*** ========== Init ========== ***/
function init(){
  try{
    // Re≈æimy
    document.querySelectorAll(".tab").forEach(b=> b.addEventListener("click", ()=> setMode(b.getAttribute("data-mode")) ));
    // Mobile select
    if (modeSelect){ modeSelect.addEventListener("change", ()=> setMode(modeSelect.value) ); }
    // UI init
    const ui=getUI(); if(ui.mode) MODE=ui.mode; else MODE="W";
    setMode(MODE);
    // Debug ON by default
    const s=getStore(); s.debug=s.debug||{}; if (typeof s.debug.enabled==="undefined") s.debug.enabled=true; setStore(s); __dbg.set(!!s.debug.enabled);
    try{ document.getElementById("debugEnable").checked=!!s.debug.enabled; }catch(_){}
    __dbg.log("Init OK; mode="+MODE);
  }catch(e){ console.error("Init error", e); }
}

document.getElementById("debugHide").addEventListener("click", ()=>{ __dbg.set(false); const s=getStore(); s.debug=s.debug||{}; s.debug.enabled=false; setStore(s); document.getElementById("debugEnable").checked=false; });
document.getElementById("debugClear").addEventListener("click", ()=> __dbg.clear());

// GO
init();
</script>
</body>
</html>
